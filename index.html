<!DOCTYPE html>
<html lang="ko" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GGP CAMERA 업무 현황 보드</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" xintegrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; }
        .category-board {
            display: flex;
            gap: 1.5rem;
            overflow-x: auto;
            padding-bottom: 1.5rem;
            min-height: 60vh;
        }
        .category-column {
            flex: 0 0 320px;
            max-width: 320px;
            min-width: 320px;
        }
        .task-list::-webkit-scrollbar { width: 5px; }
        .task-list::-webkit-scrollbar-thumb { background-color: #a3a3a3; border-radius: 10px; }
        .dark .task-list::-webkit-scrollbar-thumb { background-color: #52525b; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200">

    <div class="container mx-auto p-4 sm:p-6 md:p-8">
        
        <header class="flex flex-col sm:flex-row items-center justify-between mb-8 gap-4">
            <h1 class="text-3xl font-bold text-gray-800 dark:text-white flex items-center gap-3">
                <i class="fa-solid fa-camera-retro text-indigo-500"></i>
                <span>GGP CAMERA 업무 현황</span>
            </h1>
            <div class="flex items-center gap-2">
                <button id="manage-category-btn" class="flex items-center gap-2 bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors shadow">
                    <i class="fa-solid fa-tags"></i><span>카테고리 관리</span>
                </button>
                <button id="add-task-btn" class="flex items-center gap-2 bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors shadow">
                    <i class="fa-solid fa-plus"></i><span>업무 추가</span>
                </button>
                <button id="dark-mode-toggle" class="w-10 h-10 flex-shrink-0 flex items-center justify-center rounded-full bg-white dark:bg-gray-700 text-gray-600 dark:text-yellow-400 hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors shadow-sm">
                    <i class="fa-solid fa-sun"></i>
                </button>
            </div>
        </header>

        <div id="category-board-container" class="category-board">
            <!-- 카테고리 컬럼이 동적으로 생성됩니다. -->
        </div>

    </div>

    <!-- 업무 추가/수정 모달 -->
    <div id="task-modal" class="fixed inset-0 bg-black/40 flex items-center justify-center hidden z-40 p-4">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-md p-6 animate-fade-in">
            <h3 id="task-modal-title" class="text-xl font-bold text-gray-700 dark:text-gray-200 mb-6"></h3>
            <form id="task-form">
                <input type="hidden" id="task-id">
                <div class="mb-4">
                    <label for="task-category" class="block text-sm font-medium text-gray-600 dark:text-gray-300 mb-1">카테고리</label>
                    <select id="task-category" class="w-full px-3 py-2 border rounded-md bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600" required></select>
                </div>
                <div class="mb-4">
                    <label for="task-title" class="block text-sm font-medium text-gray-600 dark:text-gray-300 mb-1">제목</label>
                    <input type="text" id="task-title" class="w-full px-3 py-2 border rounded-md bg-gray-50 dark:bg-gray-700" required>
                </div>
                <div class="mb-4">
                    <label for="task-url" class="block text-sm font-medium text-gray-600 dark:text-gray-300 mb-1">URL</label>
                    <input type="url" id="task-url" class="w-full px-3 py-2 border rounded-md bg-gray-50 dark:bg-gray-700" placeholder="https://...">
                </div>
                <div class="mb-4">
                    <label for="task-name" class="block text-sm font-medium text-gray-600 dark:text-gray-300 mb-1">담당자</label>
                    <select id="task-name" class="w-full px-3 py-2 border rounded-md bg-gray-50 dark:bg-gray-700" required></select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 dark:text-gray-300 mb-2">상태</label>
                    <div class="flex items-center gap-8">
                        <label class="flex items-center gap-2"><input type="radio" name="task-status" value="inProgress" checked>진행 중</label>
                        <label class="flex items-center gap-2"><input type="radio" name="task-status" value="completed">완료</label>
                    </div>
                </div>
                <div id="end-date-wrapper" class="mt-4 mb-6 hidden">
                     <label for="task-date" class="block text-sm font-medium text-gray-600 dark:text-gray-300 mb-1">완료일</label>
                     <input type="date" id="task-date" class="w-full px-3 py-2 border rounded-md bg-gray-50 dark:bg-gray-700">
                </div>

                <div class="flex justify-end gap-3 mt-8">
                    <button type="button" id="close-task-modal-btn" class="px-4 py-2 rounded-md bg-gray-200 dark:bg-gray-600">취소</button>
                    <button type="submit" class="bg-indigo-600 text-white font-bold py-2 px-6 rounded-md">저장</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- 카테고리 관리 모달 -->
    <div id="category-modal" class="fixed inset-0 bg-black/40 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-md p-6 animate-fade-in">
            <h3 class="text-xl font-bold text-gray-700 dark:text-gray-200 mb-6">카테고리 관리</h3>
            <div id="category-list" class="space-y-2 mb-6 max-h-60 overflow-y-auto"></div>
            <form id="add-category-form" class="flex gap-2">
                <input type="text" id="new-category-name" class="flex-grow px-3 py-2 border rounded-md bg-gray-50 dark:bg-gray-700" placeholder="새 카테고리 이름" required>
                <button type="submit" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-md">추가</button>
            </form>
             <div class="flex justify-end mt-8">
                 <button type="button" id="close-category-modal-btn" class="px-4 py-2 rounded-md bg-gray-200 dark:bg-gray-600">닫기</button>
            </div>
        </div>
    </div>

    <!-- 삭제 확인 모달 -->
    <div id="delete-confirm-modal" class="fixed inset-0 bg-black/40 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-sm p-6 animate-fade-in">
            <h3 id="delete-confirm-title" class="text-lg font-bold text-gray-800 dark:text-gray-100 mb-2"></h3>
            <p id="delete-confirm-message" class="text-gray-600 dark:text-gray-300 mb-6"></p>
            <div class="flex justify-end gap-3">
                <button id="cancel-delete-btn" class="px-4 py-2 rounded-md bg-gray-200 dark:bg-gray-600">취소</button>
                <button id="confirm-delete-btn" class="px-4 py-2 rounded-md bg-red-600 text-white">삭제</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, onSnapshot, addDoc, updateDoc, doc, deleteDoc, serverTimestamp, enableIndexedDbPersistence, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase 구성 ---
        const firebaseConfig = {
            apiKey: "AIzaSyD6LVOtT0x30CQNZDt5aSUEBKT8vXPhM6k",
            authDomain: "ggp-camera.firebaseapp.com",
            projectId: "ggp-camera",
            storageBucket: "ggp-camera.appspot.com",
            messagingSenderId: "906682771595",
            appId: "1:906682771595:web:431b539435f4a0ca294c8e"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = firebaseConfig.appId;
        enableIndexedDbPersistence(db).catch(console.warn);

        // --- 상수 및 상태 변수 ---
        const ASSIGNEES = { "Aiden Kim": {i:"A", c:"bg-blue-500"}, "Matthew Kim": {i:"M", c:"bg-green-500"}, "Kai Kim": {i:"K", c:"bg-yellow-500"}, "Trey Song": {i:"T", c:"bg-purple-500"} };
        let categories = [];
        let newTasks = [];
        let oldTasks = [];
        let itemToDelete = { id: null, type: null };

        // --- DOM 요소 ---
        const elements = {
            board: document.getElementById('category-board-container'),
            taskModal: document.getElementById('task-modal'),
            taskModalTitle: document.getElementById('task-modal-title'),
            taskForm: document.getElementById('task-form'),
            taskIdInput: document.getElementById('task-id'),
            taskCategorySelect: document.getElementById('task-category'),
            taskNameSelect: document.getElementById('task-name'),
            endDateWrapper: document.getElementById('end-date-wrapper'),
            categoryModal: document.getElementById('category-modal'),
            categoryList: document.getElementById('category-list'),
            addCategoryForm: document.getElementById('add-category-form'),
            deleteConfirmModal: document.getElementById('delete-confirm-modal'),
            deleteConfirmTitle: document.getElementById('delete-confirm-title'),
            deleteConfirmMessage: document.getElementById('delete-confirm-message'),
            addTaskBtn: document.getElementById('add-task-btn'),
            manageCategoryBtn: document.getElementById('manage-category-btn'),
            closeTaskModalBtn: document.getElementById('close-task-modal-btn'),
            closeCategoryModalBtn: document.getElementById('close-category-modal-btn'),
            confirmDeleteBtn: document.getElementById('confirm-delete-btn'),
            cancelDeleteBtn: document.getElementById('cancel-delete-btn'),
            darkModeToggle: document.getElementById('dark-mode-toggle'),
            htmlElement: document.documentElement
        };

        // --- 초기화 ---
        function populateAssignees() {
            elements.taskNameSelect.innerHTML = Object.keys(ASSIGNEES).map(name => `<option value="${name}">${name}</option>`).join('');
        }

        // --- 모달 관리 ---
        function openTaskModal(task = null) {
            elements.taskForm.reset();
            populateAssignees();
            elements.taskCategorySelect.innerHTML = categories.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
            
            if (task) {
                elements.taskModalTitle.textContent = '업무 수정';
                elements.taskIdInput.value = task.id;
                document.getElementById('task-category').value = task.category || '기본';
                document.getElementById('task-title').value = task.title;
                document.getElementById('task-url').value = task.url;
                document.getElementById('task-name').value = task.name;
                const statusRadio = document.querySelector(`input[name="task-status"][value="${task.status}"]`);
                if(statusRadio) statusRadio.checked = true;
                const isCompleted = task.status === 'completed';
                elements.endDateWrapper.classList.toggle('hidden', !isCompleted);
                if(isCompleted) document.getElementById('task-date').value = task.endDate;
            } else {
                elements.taskModalTitle.textContent = '새 업무 추가';
                elements.endDateWrapper.classList.add('hidden');
                document.querySelector('input[name="task-status"][value="inProgress"]').checked = true;
            }
            elements.taskModal.classList.remove('hidden');
        }

        function openCategoryModal() { elements.categoryModal.classList.remove('hidden'); }
        function openDeleteConfirmModal(id, type) {
            itemToDelete = { id, type };
            elements.deleteConfirmTitle.textContent = type === 'task' ? '업무 삭제' : '카테고리 삭제';
            elements.deleteConfirmMessage.textContent = `정말로 이 ${type === 'task' ? '업무' : '카테고리'}를 삭제하시겠습니까?`;
            elements.deleteConfirmModal.classList.remove('hidden');
        }

        // --- 데이터 처리 (CRUD) ---
        async function handleTaskFormSubmit(e) {
            e.preventDefault();
            const taskId = elements.taskIdInput.value;
            const data = {
                category: document.getElementById('task-category').value,
                title: document.getElementById('task-title').value,
                url: document.getElementById('task-url').value,
                name: document.getElementById('task-name').value,
                status: document.querySelector('input[name="task-status"]:checked').value,
                endDate: document.getElementById('task-date').value || null
            };

            elements.taskModal.classList.add('hidden');
            if (taskId) {
                await updateDoc(doc(db, "tasks", taskId), data);
            } else {
                data.createdAt = serverTimestamp();
                await addDoc(collection(db, "tasks"), data);
            }
        }
        
        async function handleAddCategoryFormSubmit(e) {
            e.preventDefault();
            const input = document.getElementById('new-category-name');
            const name = input.value.trim();
            if (name) {
                await addDoc(collection(db, "categories"), { name, createdAt: serverTimestamp() });
                input.value = '';
            }
        }
        
        async function handleDeleteConfirmed() {
            if (!itemToDelete.id) return;
            const { id, type } = itemToDelete;
            // ** 변경: 이전 데이터 소스에서도 삭제 시도 **
            const collectionsToDeleteFrom = type === 'task' ? ['tasks', `artifacts/${appId}/public/data/work-pages`] : ['categories'];
            try {
                 for (const coll of collectionsToDeleteFrom) {
                    const docRef = doc(db, coll, id);
                    // 에러를 무시하고 다음 컬렉션 시도
                    await deleteDoc(docRef).catch(() => {});
                 }
            } catch(e) { /* ignore */ }
            elements.deleteConfirmModal.classList.add('hidden');
        }


        // --- UI 렌더링 ---
        function renderBoard(categories, allTasks) {
            elements.board.innerHTML = '';
            const tasksByCategory = categories.reduce((acc, category) => ({ ...acc, [category.name]: [] }), {});

            allTasks.forEach(task => {
                const categoryName = task.category || '기본';
                if(tasksByCategory[categoryName]) {
                    tasksByCategory[categoryName].push(task);
                }
            });

            categories.forEach(category => {
                const column = document.createElement('div');
                column.className = 'category-column bg-gray-200 dark:bg-gray-800 rounded-lg p-3 flex flex-col';
                column.innerHTML = `
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="font-bold text-lg">${category.name}</h2>
                        <button class="delete-category-btn text-gray-400 hover:text-red-500" data-id="${category.id}"><i class="fa-solid fa-trash-can fa-sm"></i></button>
                    </div>
                    <ul class="task-list flex-grow space-y-3 pr-2 overflow-y-auto"></ul>`;
                
                const taskListEl = column.querySelector('.task-list');
                const sortedTasks = tasksByCategory[category.name].sort((a,b) => {
                    const timeA = a.createdAt?.toMillis() || new Date(a.date || 0).getTime();
                    const timeB = b.createdAt?.toMillis() || new Date(b.date || 0).getTime();
                    return timeB - timeA;
                });
                
                sortedTasks.forEach(task => {
                    const taskEl = document.createElement('li');
                    taskEl.className = 'bg-white dark:bg-gray-700 rounded-md shadow p-3 cursor-pointer group';
                    taskEl.dataset.id = task.id;
                    const style = ASSIGNEES[task.name] || {i:"?", c:"bg-gray-400"};
                    
                    const statusHTML = task.status === 'inProgress' 
                        ? `<span class="text-xs font-bold text-blue-500">진행 중</span>`
                        : `<span class="text-xs font-mono text-gray-400 dark:text-gray-500">${new Date(task.endDate).getMonth()+1}.${new Date(task.endDate).getDate()} 완료</span>`;

                    taskEl.innerHTML = `
                        <a href="${task.url || '#'}" target="_blank" class="font-semibold text-gray-800 dark:text-gray-200 mb-2 block">${task.title}</a>
                        <div class="flex justify-between items-center">
                            <div class="flex items-center gap-2">
                                <div title="${task.name}" class="w-6 h-6 rounded-full ${style.c} text-white text-xs flex items-center justify-center font-bold">${style.i}</div>
                                ${statusHTML}
                            </div>
                            <div class="opacity-0 group-hover:opacity-100 transition-opacity">
                                <button class="edit-task-btn text-gray-400 hover:text-blue-500 mr-2" data-id="${task.id}"><i class="fa-solid fa-pencil"></i></button>
                                <button class="delete-task-btn text-gray-400 hover:text-red-500" data-id="${task.id}"><i class="fa-solid fa-trash-can"></i></button>
                            </div>
                        </div>`;
                    taskListEl.appendChild(taskEl);
                });
                elements.board.appendChild(column);
            });
            elements.board.innerHTML += `<div class="category-column"><button id="add-category-btn" class="w-full h-12 bg-gray-300/50 dark:bg-gray-700/50 rounded-lg flex items-center justify-center text-gray-500 hover:bg-gray-300 dark:hover:bg-gray-700 transition-colors"><i class="fa-solid fa-plus mr-2"></i> 새 카테고리 추가</button></div>`;
        }
        
        function renderCategoryList(categories) {
            elements.categoryList.innerHTML = categories.map(c => `
                <div class="flex justify-between items-center p-2 bg-gray-100 dark:bg-gray-700 rounded-md">
                    <span>${c.name}</span>
                    <button class="delete-category-btn text-gray-400 hover:text-red-500" data-id="${c.id}"><i class="fa-solid fa-trash-can"></i></button>
                </div>`).join('');
        }

        function handleFirestoreError(error) { /* ... (이전과 동일) ... */ }
        
        async function initializeDefaultCategories() {
            const categoriesRef = collection(db, "categories");
            const snapshot = await getDocs(categoriesRef);
            if (snapshot.empty) {
                const defaultCategories = ["기본", "교육", "촬영 퀄리티", "아카이빙"];
                const promises = defaultCategories.map(name => addDoc(categoriesRef, { name, createdAt: serverTimestamp() }));
                await Promise.all(promises);
            }
        }

        // --- 이벤트 리스너 ---
        elements.closeTaskModalBtn.addEventListener('click', () => elements.taskModal.classList.add('hidden'));
        elements.manageCategoryBtn.addEventListener('click', openCategoryModal);
        elements.closeCategoryModalBtn.addEventListener('click', () => elements.categoryModal.classList.add('hidden'));
        elements.confirmDeleteBtn.addEventListener('click', handleDeleteConfirmed);
        elements.cancelDeleteBtn.addEventListener('click', () => elements.deleteConfirmModal.classList.add('hidden'));
        elements.taskForm.addEventListener('submit', handleTaskFormSubmit);
        elements.addCategoryForm.addEventListener('submit', handleAddCategoryFormSubmit);
        
        document.addEventListener('click', e => {
            const target = e.target;
            const editBtn = target.closest('.edit-task-btn');
            const deleteBtn = target.closest('.delete-task-btn');
            const deleteCategoryBtn = target.closest('.delete-category-btn');
            const addCategoryBtn = target.closest('#add-category-btn');

            if (editBtn) {
                const taskId = editBtn.dataset.id;
                const task = [...newTasks, ...oldTasks].find(t => t.id === taskId);
                if (task) openTaskModal(task);
            }
            if (deleteBtn) openDeleteConfirmModal(deleteBtn.dataset.id, 'task');
            if (deleteCategoryBtn) openDeleteConfirmModal(deleteCategoryBtn.dataset.id, 'category');
            if (addCategoryBtn) openCategoryModal();
        });
        
        document.querySelector('form').addEventListener('change', e => {
            if(e.target.name === 'task-status') {
                elements.endDateWrapper.classList.toggle('hidden', e.target.value === 'inProgress');
            }
        });

        // --- 데이터 구독 및 시작 ---
        onAuthStateChanged(auth, async user => {
            if (user) {
                await initializeDefaultCategories(); 
                
                let isCategoriesLoaded = false, isNewTasksLoaded = false, isOldTasksLoaded = false;
                const mergeAndRender = () => {
                    if (isCategoriesLoaded && isNewTasksLoaded && isOldTasksLoaded) {
                        const allTasks = [...newTasks, ...oldTasks];
                        renderBoard(categories, allTasks);
                    }
                };

                onSnapshot(query(collection(db, "categories"), orderBy("createdAt", "asc")), snapshot => {
                    categories = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderCategoryList(categories);
                    isCategoriesLoaded = true;
                    mergeAndRender();
                }, handleFirestoreError);

                onSnapshot(collection(db, "tasks"), snapshot => {
                    newTasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    isNewTasksLoaded = true;
                    mergeAndRender();
                }, handleFirestoreError);
                
                const oldCollRef = collection(db, 'artifacts', appId, 'public', 'data', 'work-pages');
                onSnapshot(oldCollRef, (snapshot) => {
                    oldTasks = snapshot.docs.map(doc => {
                        const data = doc.data();
                        return { id: doc.id, ...data, category: '기본', status: 'completed', endDate: data.date, createdAt: null };
                    });
                    isOldTasksLoaded = true;
                    mergeAndRender();
                }, () => { 
                    oldTasks = [];
                    isOldTasksLoaded = true;
                    mergeAndRender();
                });

            } else {
                signInAnonymously(auth);
            }
        });
        
        // --- 다크모드 ---
        const initDarkMode = () => { /* ... (이전과 동일) ... */ };
        const toggleDarkMode = () => { /* ... (이전과 동일) ... */ };
        elements.darkModeToggle.addEventListener('click', toggleDarkMode);
        initDarkMode();
    </script>
</body>
</html>
